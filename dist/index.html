<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>工作台 - 星丽仁系统</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <style>
        /* === Material Design 3 风格变量 === */
        :root {
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-surface: #FDF8FD;
            --md-sys-color-surface-container: #F3EDF7; /* 卡片背景 */
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #79747E;
            --md-sys-color-error: #B3261E; /* 错误/退出色 */
            
            --elevation-1: 0px 1px 3px 1px rgba(0, 0, 0, 0.15), 0px 1px 2px 0px rgba(0, 0, 0, 0.3);
            --elevation-2: 0px 2px 6px 2px rgba(0, 0, 0, 0.15), 0px 1px 2px 0px rgba(0, 0, 0, 0.3);
            
            --border-radius-lg: 16px;
            --border-radius-md: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            min-height: 100vh;
            padding: 16px;
            max-width: 800px; /* 限制最大宽度，大屏更好看 */
            margin: 0 auto;
        }

        /* === 头部区域 === */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
            padding: 8px 4px;
        }

        .brand-area {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            height: 48px;
            width: auto;
            object-fit: contain;
        }

        /* 用户信息区域容器 */
        .user-wrapper {
            display: flex;
            align-items: center;
            gap: 12px; /* 头像信息和退出按钮的间距 */
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--md-sys-color-on-surface);
        }

        .user-role {
            font-size: 12px;
            color: var(--md-sys-color-primary);
            background-color: var(--md-sys-color-primary-container);
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
            margin-top: 4px;
            font-weight: 500;
        }

        /* === 退出按钮样式 === */
        .logout-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%; /* 圆形按钮 */
            color: var(--md-sys-color-outline);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logout-btn i {
            font-size: 24px;
        }

        .logout-btn:active {
            background-color: rgba(0,0,0,0.05);
        }

        @media (hover: hover) {
            .logout-btn:hover {
                background-color: #FFF8F7; /* 极淡的红色背景 */
                color: var(--md-sys-color-error); /* 变红 */
            }
        }

        /* === 分类标题 === */
        .section-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
            margin: 24px 0 12px 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background-color: var(--md-sys-color-outline);
            opacity: 0.2;
        }

        /* === 网格布局 === */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 默认4列 */
            gap: 12px;
            margin-bottom: 16px;
        }

        /* 手机端适配：3列或4列取决于屏幕宽度 */
        @media (max-width: 400px) {
            .grid-container { grid-template-columns: repeat(3, 1fr); }
        }

        /* === 应用卡片 === */
        .app-card {
            background-color: var(--md-sys-color-surface-container);
            border-radius: var(--border-radius-md);
            padding: 16px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--md-sys-color-on-surface);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            border: 1px solid transparent;
        }

        /* 点击/触摸反馈 */
        .app-card:active {
            transform: scale(0.96);
            background-color: rgba(103, 80, 164, 0.12);
        }
        
        /* 桌面端 Hover 效果 */
        @media (hover: hover) {
            .app-card:hover {
                box-shadow: var(--elevation-1);
                background-color: #fff;
                transform: translateY(-2px);
            }
        }

        .app-icon {
            width: 42px;
            height: 42px;
            object-fit: contain;
            margin-bottom: 10px;
            /* 给图标加一点点投影，更有层次感 */
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .app-name {
            font-size: 13px;
            line-height: 1.2;
            text-align: center;
            font-weight: 500;
            /* 限制两行文字，超出省略 */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            color: var(--md-sys-color-on-surface-variant);
        }

        /* === 加载/空状态 === */
        .state-box {
            text-align: center;
            padding: 60px 0;
            color: var(--md-sys-color-outline);
        }
        .loading-spinner {
            font-size: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-bottom: 10px;
            color: var(--md-sys-color-primary);
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

<header class="header">
    <div class="brand-area">
        <img src="https://xingliren.oss-cn-hangzhou.aliyuncs.com/img/logo.png" alt="Logo" class="logo">
    </div>
    
    <div class="user-wrapper">
        <div class="user-info">
            <div id="userName" class="user-name">加载中...</div>
            <div id="userRole" class="user-role">...</div>
        </div>
        <button onclick="handleLogout()" class="logout-btn" title="退出登录">
            <i class="ri-logout-box-r-line"></i>
        </button>
    </div>
</header>

<main id="mainContent">
    <div class="state-box">
        <i class="ri-loader-4-line loading-spinner"></i>
        <p>正在获取权限配置...</p>
    </div>
</main>

<script>
    // 1. 初始化用户信息
    async function initUser() {
        const localName = localStorage.getItem('user_name');
        const localRole = localStorage.getItem('user_role');
        
        if (localName) {
            updateUserUI(localName, localRole);
        }

        try {
            const res = await fetch('/api/user/info');
            if (res.ok) {
                const data = await res.json();
                updateUserUI(data.name, data.role);
                localStorage.setItem('user_name', data.name);
                localStorage.setItem('user_role', data.role);
            } else if (res.status === 401) {
                window.location.href = '/login.html';
            }
        } catch(e) { console.warn('用户状态检查失败'); }
    }

    function updateUserUI(name, role) {
        document.getElementById('userName').innerText = name || '未命名';
        document.getElementById('userRole').innerText = role || '员工';
    }

    // 2. 加载并分组显示菜单
    async function loadMenu() {
        const main = document.getElementById('mainContent');
        
        try {
            const res = await fetch('/api/app/menu');
            if (!res.ok) throw new Error('网络请求失败');
            
            const apps = await res.json();

            if (!apps || apps.length === 0) {
                main.innerHTML = `
                    <div class="state-box">
                        <i class="ri-inbox-line" style="font-size:48px; margin-bottom:12px;"></i>
                        <p>暂无可用应用，请联系管理员</p>
                    </div>`;
                return;
            }

            // === 核心逻辑：按类型分组 ===
            // 使用 Map 保持插入顺序 (如果后端排序了，前端也能保持)
            const grouped = new Map();

            apps.forEach(app => {
                const type = app.type || '其他应用';
                if (!grouped.has(type)) {
                    grouped.set(type, []);
                }
                grouped.get(type).push(app);
            });

            // 清空加载状态
            main.innerHTML = '';

            // 渲染分组
            grouped.forEach((groupApps, typeName) => {
                // 1. 创建标题
                const title = document.createElement('h3');
                title.className = 'section-title';
                title.innerText = typeName;
                main.appendChild(title);

                // 2. 创建 Grid 容器
                const grid = document.createElement('div');
                grid.className = 'grid-container';

                // 3. 填充卡片
                groupApps.forEach(app => {
                    const card = document.createElement('a');
                    card.className = 'app-card';
                    card.href = app.url;
                    
                    // 图片错误兜底
                    const imgUrl = app.icon || 'https://via.placeholder.com/80?text=Icon';
                    
                    card.innerHTML = `
                        <img src="${imgUrl}" class="app-icon" alt="${app.name}" loading="lazy" onerror="this.src='https://via.placeholder.com/80?text=Err'">
                        <span class="app-name">${app.name}</span>
                    `;
                    grid.appendChild(card);
                });

                main.appendChild(grid);
            });

        } catch (e) {
            console.error(e);
            main.innerHTML = `
                <div class="state-box">
                    <i class="ri-wifi-off-line" style="font-size:48px; color:var(--md-sys-color-error);"></i>
                    <p style="margin-top:12px">加载失败，请刷新重试</p>
                </div>`;
        }
    }

    // 3. 退出登录逻辑
    function handleLogout() {
        if (!confirm('确定要退出当前账号吗？')) return;

        // 清除前端缓存
        localStorage.removeItem('user_name');
        localStorage.removeItem('user_role');

        // 尝试清除 Cookie (如果不是 HttpOnly)
        document.cookie = "auth_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";

        // 跳转登录页
        window.location.href = '/login.html';
    }

    // 启动
    initUser();
    loadMenu();
</script>

</body>
</html>