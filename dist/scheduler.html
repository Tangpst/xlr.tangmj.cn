<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>当日预约表</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="./js/auth.js"></script>
    <link href="https://xingliren.oss-cn-hangzhou.aliyuncs.com/assets/remixicon.css" rel="stylesheet">
    <link href="https://xingliren.oss-cn-hangzhou.aliyuncs.com/assets/google-fonts.css" rel="stylesheet">
    
    <style>
        /* CSS 样式保持不变 */
        :root {
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            --md-sys-color-surface: #FDF8FD;
            --md-sys-color-surface-container: #F3EDF7;
            --md-sys-color-surface-variant: #E7E0EC;
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-on-surface-variant: #49454F;
            --md-sys-color-outline: #79747E;
            --md-sys-color-outline-variant: #CAC4D0;
            --dept-medical-bg: #E8DEF8;
            --dept-medical-text: #1D192B;
            --dept-life-bg: #D7E3FF;
            --dept-life-text: #001C3B;
            --radius-l: 24px;
            --radius-m: 16px;
            --radius-s: 8px;
            --radius-full: 9999px;
            --shadow-1: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            --shadow-2: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 2px 6px 2px rgba(0, 0, 0, 0.15);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Roboto', 'Noto Sans SC', sans-serif; background-color: var(--md-sys-color-surface); color: var(--md-sys-color-on-surface); padding: 24px 16px; line-height: 1.5; }
        .container { max-width: 900px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
        .header h1 { font-size: 1.75rem; font-weight: 500; color: var(--md-sys-color-on-surface); display: flex; align-items: center; gap: 12px; margin-right: auto; letter-spacing: -0.5px; }
        .date-input-wrapper { position: relative; background: var(--md-sys-color-surface-container); border-radius: var(--radius-s); display: flex; align-items: center; padding: 0 12px; height: 48px; min-width: 160px; }
        .date-input { border: none; background: transparent; font-family: inherit; font-size: 1rem; color: var(--md-sys-color-on-surface); outline: none; width: 100%; cursor: pointer; }
        .resting-banner { background-color: #FFF4DE; color: #5C430D; padding: 16px; border-radius: var(--radius-m); margin-bottom: 24px; display: flex; align-items: flex-start; gap: 12px; font-size: 0.95rem; line-height: 1.4; }
        .resting-banner i { font-size: 1.2rem; margin-top: 1px; }
        .filter-tabs { display: flex; gap: 10px; margin-bottom: 32px; overflow-x: auto; padding-bottom: 4px; }
        .filter-chip { border: 1px solid var(--md-sys-color-outline-variant); background: transparent; padding: 8px 16px; border-radius: var(--radius-full); font-size: 0.9rem; font-weight: 500; color: var(--md-sys-color-on-surface-variant); cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px; white-space: nowrap; }
        .filter-chip:hover { background-color: var(--md-sys-color-surface-variant); }
        .filter-chip.active { background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); border-color: transparent; }
        .filter-chip.active i { display: block; }
        .filter-chip i { display: none; font-size: 1.1em; }
        .schedule-list { display: flex; flex-direction: column; gap: 16px; }
        .schedule-card { background: #fff; border-radius: var(--radius-l); padding: 20px 24px; display: grid; grid-template-columns: 100px 1fr auto; align-items: center; gap: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #f0f0f0; transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden; }
        .schedule-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-2); border-color: transparent; }
        .section-time { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding-right: 24px; border-right: 1px solid var(--md-sys-color-outline-variant); min-width: 100px; }
        .time-start { font-size: 1.5rem; font-weight: 700; color: var(--md-sys-color-on-surface); line-height: 1; }
        .time-end { font-size: 0.85rem; color: var(--md-sys-color-on-surface-variant); margin-top: 4px; }
        .time-duration { margin-top: 6px; font-size: 0.75rem; background: var(--md-sys-color-surface-container); padding: 2px 8px; border-radius: 4px; color: var(--md-sys-color-on-surface-variant); }
        .section-main { display: flex; flex-direction: column; gap: 10px; }
        .client-info { display: flex; align-items: center; gap: 8px; font-size: 1.1rem; font-weight: 500; color: var(--md-sys-color-on-surface); }
        .client-icon { color: var(--md-sys-color-primary); }
        .project-list { display: flex; gap: 8px; flex-wrap: wrap; }
        .tag { padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 500; display: inline-flex; align-items: center; background-color: var(--md-sys-color-surface-container); color: var(--md-sys-color-on-surface-variant); }
        .tag-水光 { background: #E6F4EA; color: #137333; }
        .tag-光子 { background: #E8F0FE; color: #1967D2; }
        .tag-清洁 { background: #F1F3F4; color: #5F6368; }
        .section-right { display: flex; flex-direction: column; align-items: flex-end; gap: 12px; min-width: 120px; }
        .tech-info { display: flex; align-items: center; gap: 8px; }
        .tech-avatar { width: 32px; height: 32px; background: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: bold; }
        .tech-name { font-size: 0.95rem; font-weight: 500; }
        .dept-wrapper { display: flex; gap: 4px; flex-wrap: wrap; justify-content: flex-end; }
        .dept-badge { font-size: 0.75rem; padding: 4px 10px; border-radius: var(--radius-full); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .dept-medical { background: var(--dept-medical-bg); color: var(--dept-medical-text); }
        .dept-life { background: var(--dept-life-bg); color: var(--dept-life-text); }
        .remark-text { font-size: 0.85rem; color: #666; background: #f9f9f9; padding: 4px 8px; border-radius: 4px; display: inline-block; margin-top: 4px; }
        .empty-state { text-align: center; padding: 60px 20px; background: #fff; border-radius: var(--radius-l); border: 1px dashed var(--md-sys-color-outline-variant); color: var(--md-sys-color-on-surface-variant); }
        @media (max-width: 768px) {
            body { padding: 16px 12px; }
            .header h1 { font-size: 1.4rem; }
            .schedule-card { grid-template-columns: 1fr; gap: 16px; padding: 16px; }
            .section-time { flex-direction: row; justify-content: space-between; align-items: baseline; border-right: none; border-bottom: 1px solid var(--md-sys-color-surface-variant); padding-right: 0; padding-bottom: 12px; width: 100%; }
            .time-wrapper { display: flex; align-items: baseline; gap: 8px; }
            .time-start { font-size: 1.4rem; }
            .time-end { font-size: 1rem; color: var(--md-sys-color-on-surface-variant); }
            .time-duration { margin-top: 0; }
            .section-main { gap: 12px; }
            .section-right { flex-direction: row; justify-content: space-between; align-items: center; width: 100%; margin-top: 4px; }
            .dept-wrapper { justify-content: flex-end; }
        }
    </style>
</head>
<body>

<div id="app" class="container">
    <div class="header">
        <h1>
            <span style="background: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); padding: 6px; border-radius: 12px; display:flex;">
                <i class="ri-calendar-event-fill"></i>
            </span> 
            当日预约表
        </h1>
        <div class="date-input-wrapper">
            <input type="date" class="date-input" v-model="searchDate" @change="loadScheduleData">
        </div>
    </div>

    <div class="resting-banner" v-if="restingList.length > 0">
        <i class="ri-information-fill"></i>
        <div>
            <div style="font-weight: 600; margin-bottom: 4px;">今日在岗</div>
            <div style="opacity: 0.9">{{ restingList.join('、') }}</div>
        </div>
    </div>

    <div class="filter-tabs" v-if="authUser.role !== '美容师'">
        <button class="filter-chip" :class="{ active: currentTab === '全部' }" @click="currentTab = '全部'">
            <i class="ri-check-line"></i> 全部
        </button>
        <button class="filter-chip" :class="{ active: currentTab === '医疗美容' }" @click="currentTab = '医疗美容'">
            <i class="ri-check-line"></i> 医疗美容
        </button>
        <button class="filter-chip" :class="{ active: currentTab === '生活美容' }" @click="currentTab = '生活美容'">
            <i class="ri-check-line"></i> 生活美容
        </button>
    </div>

    <div class="schedule-list">
        <div v-if="loading" class="empty-state">
            <i class="ri-loader-4-line ri-spin" style="font-size: 24px;"></i> 
            <div style="margin-top: 10px">正在同步数据...</div>
        </div>

        <div v-else-if="filteredSchedule.length === 0" class="empty-state">
            <i class="ri-calendar-line" style="font-size: 3rem; color: var(--md-sys-color-outline-variant); margin-bottom: 16px;"></i>
            <p>该日期暂无预约安排</p>
        </div>

        <div v-else class="schedule-card" v-for="(item, index) in filteredSchedule" :key="index">
            <div class="section-time">
                <div class="time-wrapper">
                    <span class="time-start">{{ item.startTime }}</span>
                    <span class="time-end" v-if="item.endTime">- {{ item.endTime }}</span>
                </div>
                <div class="time-duration">{{ item.duration }} 分钟</div>
            </div>

            <div class="section-main">
                <div class="client-info">
                    <i class="ri-user-smile-fill client-icon"></i>
                    <span>{{ item.displayClient }}</span>
                </div>
                <div class="project-list">
                    <span v-if="item.service.length === 0" class="tag tag-default">无项目</span>
                    <span 
                        v-for="(serviceName, sIndex) in item.service" 
                        :key="sIndex"
                        class="tag" 
                        :class="getTagClass(serviceName)">
                        {{ serviceName }}
                    </span>
                </div>
                <div v-if="item.remark" class="remark-text">
                    <i class="ri-sticky-note-line" style="vertical-align: middle; margin-right: 2px;"></i> 
                    {{ item.remark }}
                </div>
            </div>

            <div class="section-right">
                <div class="dept-wrapper">
                    <span 
                        v-for="(deptName, dIndex) in item.depts" 
                        :key="dIndex"
                        class="dept-badge" 
                        :class="deptName === '医疗美容' ? 'dept-medical' : 'dept-life'">
                        {{ deptName }}
                    </span>
                </div>
                <div class="tech-info">
                    <div class="tech-avatar">{{ item.tech.charAt(0) }}</div>
                    <span class="tech-name">{{ item.tech }}</span>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            // 【集成】引入 auth.js 的功能
            const { authUser, fetchUser, isShareholder, isMe } = window.useAuth();

            const getTodayDate = () => {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const searchDate = ref(getTodayDate());
            const currentTab = ref('全部');
            const rawData = ref([]);
            const restingList = ref([]);
            const loading = ref(false);
            const API_URL = './api/scheduler';

            const extractWpsData = (json) => {
                if (!json || !json.success) return [];
                if (Array.isArray(json.data) && json.data.length > 0 && json.data[0].records) {
                    return json.data[0].records;
                }
                if (Array.isArray(json.data)) {
                    return json.data;
                }
                return [];
            };

            const parseDisplayValue = (val) => {
                if (Array.isArray(val)) {
                    if (val.length === 0) return '';
                    return val[0].name ? val[0].name : val[0];
                }
                return val || '';
            };

            const parseDepartments = (val) => {
                if (!val) return ['未分类'];
                if (Array.isArray(val)) {
                    return val.map(v => (typeof v === 'object' ? v.name : v));
                }
                return [val];
            };

            const loadScheduleData = async () => {
                loading.value = true;
                rawData.value = [];
                restingList.value = [];
                
                try {
                    const apiDateParam = searchDate.value.replace(/-/g, '/');
                    const [scheduleRes, onDutyRes] = await Promise.all([
                        fetch(`${API_URL}?date=${apiDateParam}&b=0`),
                        fetch(`${API_URL}?b=1`)
                    ]);

                    const scheduleJson = await scheduleRes.json();
                    const onDutyJson = await onDutyRes.json();

                    const scheduleRecords = extractWpsData(scheduleJson);
                    
                    const validSchedule = scheduleRecords.filter(item => {
                        const f = item.fields || {};
                        return f['客户姓名'] && String(f['客户姓名']).trim() !== '';
                    });

                    // --- 处理预约列表数据 ---
                    let processedData = validSchedule.map(item => {
                        const f = item.fields || {};

                        let serviceArr = [];
                        if (Array.isArray(f['项目'])) {
                            serviceArr = f['项目'].map(s => typeof s === 'object' ? s.name : s);
                        } else if (f['项目']) {
                            serviceArr = [f['项目']];
                        }

                        const deptArr = parseDepartments(f['部门']);

                        // === 隐私逻辑 (股东特例) ===
                        const realName = f['客户姓名'];
                        const submitterPhone = f['提交电话'] || f['submitter'] || ''; 
                        
                        let displayClient = realName;

                        // 逻辑：如果是股东，且这条记录不是自己提交的，则屏蔽姓名
                        if (isShareholder.value && !isMe(submitterPhone)) {
                            displayClient = '***';
                        }
                        
                        return {
                            id: item.id,
                            date: f['日期'] || searchDate.value,
                            client: realName, 
                            displayClient: displayClient, // 使用计算后的显示名
                            tech: parseDisplayValue(f['技师&护士']) || '待定', 
                            depts: deptArr,
                            service: serviceArr,
                            startTime: (f['预约时间'] || '').substring(0, 5),
                            endTime: (f['结束时间'] || '').substring(0, 5),
                            duration: f['时长'] ||  0,
                            remark: f['备注'] || ''
                        };
                    });

                    // 角色过滤逻辑 (美容师只看生活美容)
                    if (authUser.role === '美容师') {
                        processedData = processedData.filter(item => 
                            item.depts && item.depts.includes('生活美容')
                        );
                        currentTab.value = '生活美容'; 
                    }

                    rawData.value = processedData;

                    // --- 处理今日在岗人员 (顶部横幅) ---
                    const onDutyRecords = extractWpsData(onDutyJson);
                    const uniqueNames = new Set(); 
                    onDutyRecords.forEach(item => {
                        const f = item.fields || {};
                        const name = f['姓名'];
                        // 屏蔽名单中的“生美”和“医美”
                        if (name && name !== '无指定' && name !== '生美' && name !== '医美') {
                            uniqueNames.add(name);
                        }
                    });
                    restingList.value = Array.from(uniqueNames);

                } catch (error) {
                    console.error('API Error:', error);
                } finally {
                    loading.value = false;
                }
            };

            const filteredSchedule = computed(() => {
                if (rawData.value.length === 0) return [];

                return rawData.value.filter(item => {
                    // 美容师已在 loadScheduleData 中过滤，这里仅响应手动 tab 切换
                    if (currentTab.value === '全部') return true;
                    return item.depts && item.depts.includes(currentTab.value);
                }).sort((a, b) => a.startTime.localeCompare(b.startTime));
            });
            
            const getTagClass = (name) => {
                const knownTags = ['水光', '光子', '清洁', '测试项目']; 
                if (knownTags.includes(name)) return 'tag-' + name;
                return 'tag-default'; 
            };

            onMounted(async () => {
                await fetchUser(); // 先获取用户角色
                loadScheduleData();
            });

            return {
                searchDate,
                currentTab,
                authUser, // 暴露给模板 (用于 v-if="authUser.role !== ...")
                filteredSchedule,
                restingList,
                loading,
                loadScheduleData,
                getTagClass
            }
        }
    }).mount('#app');
</script>

</body>
</html>