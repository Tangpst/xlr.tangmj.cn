<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="星丽仁·医疗美容">
    <meta property="og:description" content="内部管理系统">
    <meta property="og:image" content="https://s.tangmj.cn/logo.png">
    <title>当日预约表</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="./js/auth.js"></script>
    <link href="https://xingliren.oss-cn-hangzhou.aliyuncs.com/assets/remixicon.css" rel="stylesheet">
    <link href="https://xingliren.oss-cn-hangzhou.aliyuncs.com/assets/google-fonts.css" rel="stylesheet">
    
    <style>
        /* --- 基础变量保持不变 --- */
        :root {
            --md-sys-color-primary: #6750A4;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            --md-sys-color-surface: #FDF8FD;
            --md-sys-color-surface-container: #F3EDF7;
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-on-surface-variant: #49454F;
            --dept-medical-bg: #E8DEF8; 
            --dept-medical-dot: #6750A4; /* 新增：医美圆点色 */
            --dept-life-bg: #D7E3FF;
            --dept-life-dot: #e02cc8;   /* 新增：生美圆点色 */
            --radius-m: 12px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Roboto', 'Noto Sans SC', sans-serif; background-color: #f7f9fc; color: #333; padding: 16px 12px; line-height: 1.5; }
        .container { max-width: 800px; margin: 0 auto; }

        /* --- 头部样式微调 --- */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 12px; }
        .header h1 { font-size: 1.4rem; font-weight: 600; color: #1a1a1a; display: flex; align-items: center; gap: 8px; }
        .header-right { display: flex; align-items: center; gap: 8px; }
        .date-input-wrapper { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 0 10px; height: 40px; display: flex; align-items: center; }
        .date-input { border: none; background: transparent; font-size: 0.95rem; outline: none; color: #333; font-family: inherit; }
        .refresh-btn { 
            background: #fff; 
            border: 1px solid #e0e0e0; 
            border-radius: 8px; 
            width: 40px; 
            height: 40px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: all 0.2s; 
            color: #666;
        }
        .refresh-btn:hover { 
            background: #f5f5f5; 
            border-color: #ccc;
            color: var(--md-sys-color-primary);
        }
        .refresh-btn:active { 
            transform: scale(0.95); 
        }
        .refresh-btn i {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }
        .refresh-btn.refreshing i {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* --- 顶部横幅 --- */
        .resting-banner { background-color: #FFF8E6; color: #7A5C00; padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; font-size: 0.9rem; border: 1px solid #FFEBA8; }

        /* --- 筛选标签 --- */
        .filter-tabs { display: flex; gap: 8px; margin-bottom: 24px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
        .filter-tabs::-webkit-scrollbar { display: none; }
        .filter-chip { border: 1px solid #e0e0e0; background: #fff; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; color: #666; transition: all 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 4px; }
        .filter-chip.active { background-color: #333; color: #fff; border-color: #333; font-weight: 500; }

        /* =========================================
           新版时间轴布局样式 (核心修改)
           ========================================= */
        .timeline-container {
            position: relative;
            padding-left: 10px; /* 给左侧时间留点呼吸空间 */
        }
        
        /* 垂直连线 */
        .timeline-container::before {
            content: '';
            position: absolute;
            left: 64px; /* 线条位置 */
            top: 10px;
            bottom: 0;
            width: 2px;
            background: #e0e0e0;
            z-index: 0;
        }

        .timeline-item {
            position: relative;
            display: flex;
            margin-bottom: 20px; /* 条目间距 */
            z-index: 1;
        }

        /* 左侧时间列 */
        .time-col {
            width: 54px; /* 固定宽度 */
            flex-shrink: 0;
            text-align: right;
            padding-right: 12px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            padding-top: 2px;
        }

        .t-start { font-size: 1.1rem; font-weight: 700; color: #1a1a1a; line-height: 1; }
        .t-end { font-size: 0.75rem; color: #888; margin-top: 2px; }

        /* 时间轴上的圆点 */
        .timeline-dot {
            position: absolute;
            left: 59px; /* 调整圆点位置使其压在线上 (64px线位置 - 5px半径) */
            top: 6px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #fff;
            border: 3px solid #ccc;
            z-index: 2;
        }
        /* 根据部门区分圆点颜色 */
        .dot-medical { border-color: var(--dept-medical-dot); }
        .dot-life { border-color: var(--dept-life-dot); }

        /* 右侧内容气泡 */
        .content-card {
            flex: 1;
            background: #fff;
            border-radius: var(--radius-m);
            padding: 12px 14px;
            box-shadow: var(--shadow-sm);
            border: 1px solid #f0f0f0;
            position: relative;
            min-width: 0; /* 防止flex子项溢出 */
        }

        /* 气泡头部：客户名 + 项目 */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            gap: 8px;
        }

        .client-box { display: flex; align-items: center; gap: 6px; }
        .client-name { font-size: 1.05rem; font-weight: 600; color: #1a1a1a; }
        .cancel-icon-btn { 
            color: #ff4d4f; 
            background: transparent; 
            border: none; 
            padding: 4px; 
            margin-top: -4px; 
            margin-right: -4px;
            cursor: pointer;
            font-size: 1.1rem;
        }
        .cancel-icon-btn:disabled { color: #ddd; }

        /* 项目标签行 */
        .tags-row { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 8px; }
        .tag { 
            font-size: 0.75rem; 
            padding: 3px 8px; 
            border-radius: 6px; 
            background: #f5f5f5; 
            color: #555; 
        }
        /* 保持原有的颜色逻辑 */
        .tag-水光 { background: #E6F4EA; color: #137333; }
        .tag-光子 { background: #E8F0FE; color: #1967D2; }
        .tag-清洁 { background: #F1F3F4; color: #5F6368; }

        /* 备注 */
        .remark-box {
            font-size: 0.8rem;
            color: #666;
            background: #fafafa;
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 8px;
            display: inline-block;
        }

        /* 底部信息栏：技师 + 部门 */
        .card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-top: 1px solid #f5f5f5;
            padding-top: 8px;
            margin-top: 4px;
        }

        .tech-box { display: flex; align-items: center; gap: 6px; }
        .tech-avatar-xs {
            width: 20px; height: 20px;
            background: #e0e0e0;
            color: #555;
            border-radius: 50%;
            font-size: 0.7rem;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold;
        }
        .tech-name { font-size: 0.85rem; color: #444; font-weight: 500; }
        
        .duration-badge {
            font-size: 0.75rem;
            color: #888;
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .empty-state { text-align: center; padding: 40px 20px; color: #999; }
    </style>
</head>
<body>

<div id="app" class="container">
    <div class="header">
        <h1>
            <span style="background: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); padding: 6px; border-radius: 8px; display:flex;">
                <i class="ri-calendar-event-line" style="font-size: 1.1rem"></i>
            </span> 
            当日预约
        </h1>
        <div class="header-right">
            <div class="date-input-wrapper">
                <input type="date" class="date-input" v-model="searchDate" @change="loadScheduleData">
            </div>
            <button class="refresh-btn" :class="{ refreshing: loading }" @click="handleRefresh" title="刷新数据">
                <i class="ri-refresh-line"></i>
            </button>
        </div>
    </div>

    <div class="resting-banner" v-if="restingList.length > 0">
        <i class="ri-user-star-line"></i>
        <div style="flex: 1">
            <div style="font-weight: 600; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 2px; opacity: 0.8;">On Duty</div>
            <div style="line-height: 1.3">{{ restingList.join('、') }}</div>
        </div>
    </div>

    <div class="filter-tabs" v-if="authUser.role !== '美容师'">
        <button class="filter-chip" :class="{ active: currentTab === '全部' }" @click="currentTab = '全部'">
            全部
        </button>
        <button class="filter-chip" :class="{ active: currentTab === '医疗美容' }" @click="currentTab = '医疗美容'">
            医美
        </button>
        <button class="filter-chip" :class="{ active: currentTab === '生活美容' }" @click="currentTab = '生活美容'">
            生美
        </button>
    </div>

    <div v-if="loading" class="empty-state">
        <i class="ri-loader-4-line ri-spin" style="font-size: 24px;"></i> 
        <div style="margin-top: 8px; font-size: 0.9rem;">加载中...</div>
    </div>

    <div v-else-if="filteredSchedule.length === 0" class="empty-state">
        <i class="ri-calendar-line" style="font-size: 3rem; opacity: 0.3; margin-bottom: 10px;"></i>
        <p>今日暂无预约</p>
    </div>

    <div v-else class="timeline-container">
        <div class="timeline-item" v-for="(item, index) in filteredSchedule" :key="index">
            
            <div class="time-col">
                <span class="t-start">{{ item.startTime }}</span>
                <span class="t-end" v-if="item.endTime">{{ item.endTime }}</span>
            </div>

            <div class="timeline-dot" 
                 :class="hasDept(item, '医疗美容') ? 'dot-medical' : 'dot-life'">
            </div>

            <div class="content-card">
                <div class="card-header">
                    <div class="client-box">
                        <span class="client-name">{{ item.displayClient }}</span>
                    </div>
                    
                    <button 
                        v-if="canCancel(item)" 
                        @click="handleCancel(item)" 
                        :disabled="item.isCanceling"
                        class="cancel-icon-btn"
                        title="取消预约">
                        <i v-if="item.isCanceling" class="ri-loader-line ri-spin"></i>
                        <i v-else class="ri-close-circle-line"></i>
                    </button>
                </div>

                <div class="tags-row">
                    <span v-if="item.service.length === 0" class="tag">无项目</span>
                    <span 
                        v-for="(serviceName, sIndex) in item.service" 
                        :key="sIndex"
                        class="tag" 
                        :class="getTagClass(serviceName)">
                        {{ serviceName }}
                    </span>
                </div>

                <div v-if="item.remark" class="remark-box">
                    <i class="ri-sticky-note-line" style="vertical-align: -2px;"></i> 
                    {{ item.remark }}
                </div>

                <div class="card-footer">
                    <div class="tech-box">
                        <div class="tech-avatar-xs">{{ item.tech.charAt(0) }}</div>
                        <span class="tech-name">{{ item.tech }}</span>
                    </div>
                    <div class="duration-badge">
                        <i class="ri-time-line"></i> {{ item.duration }}m
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            // ================= 逻辑部分完全保持不变 =================
            const { authUser, fetchUser, isShareholder, isMe } = window.useAuth();

            const getTodayDate = () => {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const searchDate = ref(getTodayDate());
            const currentTab = ref('全部');
            const rawData = ref([]);
            const restingList = ref([]);
            const loading = ref(false);
            const API_URL = './api/scheduler';

            const extractWpsData = (json) => {
                if (!json || !json.success) return [];
                if (Array.isArray(json.data) && json.data.length > 0 && json.data[0].records) {
                    return json.data[0].records;
                }
                if (Array.isArray(json.data)) {
                    return json.data;
                }
                return [];
            };

            const parseDisplayValue = (val) => {
                if (Array.isArray(val)) {
                    if (val.length === 0) return '';
                    return val[0].name ? val[0].name : val[0];
                }
                return val || '';
            };

            const parseDepartments = (val) => {
                if (!val) return ['未分类'];
                if (Array.isArray(val)) {
                    // 处理数组，提取每个元素的值（可能是对象或字符串）
                    const depts = val.map(v => {
                        if (typeof v === 'object' && v !== null) {
                            return v.name || v.value || String(v);
                        }
                        return String(v).trim();
                    }).filter(v => v && v !== ''); // 过滤空值
                    return depts.length > 0 ? depts : ['未分类'];
                }
                // 处理单个值
                const deptStr = String(val).trim();
                return deptStr ? [deptStr] : ['未分类'];
            };

            const canCancel = (item) => {
                const role = authUser.role;
                if (role === '美容师' || role === '护士') return false;
                if (role === '股东') return isMe(item.submitterPhone);
                return true;
            };

            const handleRefresh = () => {
                loadScheduleData();
            };

            const handleCancel = async (item) => {
                if (!confirm(`确定要取消【${item.client}】的预约吗？`)) return;
                if (!item.customId) {
                    alert("无ID，无法取消");
                    return;
                }
                try {
                    item.isCanceling = true;
                    const webhookUrl = './api/cancel_schedule';
                    const res = await fetch(webhookUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ "ID": item.customId })
                    });
                    if (res.ok) {
                        alert('取消成功');
                        loadScheduleData();
                    } else {
                        alert('取消失败');
                    }
                } catch (e) {
                    console.error(e);
                    alert('网络请求出错');
                } finally {
                    if (item) item.isCanceling = false;
                }
            };

            const loadScheduleData = async () => {
                loading.value = true;
                rawData.value = [];
                restingList.value = [];
                try {
                    const apiDateParam = searchDate.value.replace(/-/g, '/');
                    const [scheduleRes, onDutyRes] = await Promise.all([
                        fetch(`${API_URL}?date=${apiDateParam}&b=0`),
                        fetch(`${API_URL}?b=1`)
                    ]);
                    const scheduleJson = await scheduleRes.json();
                    const onDutyJson = await onDutyRes.json();
                    const scheduleRecords = extractWpsData(scheduleJson);
                    const validSchedule = scheduleRecords.filter(item => {
                        const f = item.fields || {};
                        return f['客户姓名'] && String(f['客户姓名']).trim() !== '';
                    });

                    let processedData = validSchedule.map(item => {
                        const f = item.fields || {};
                        let serviceArr = [];
                        if (Array.isArray(f['项目'])) {
                            serviceArr = f['项目'].map(s => typeof s === 'object' ? s.name : s);
                        } else if (f['项目']) {
                            serviceArr = [f['项目']];
                        }
                        const deptArr = parseDepartments(f['部门']);
                        const realName = f['客户姓名'];
                        const submitterPhone = f['提交电话'] || f['submitter'] || f['提交人手机'] || ''; 
                        const customId = f['ID']; 
                        let displayClient = realName;
                        if (isShareholder.value && !isMe(submitterPhone)) {
                            displayClient = '***';
                        }
                        return {
                            id: item.id,
                            customId: customId,
                            submitterPhone: submitterPhone,
                            date: f['日期'] || searchDate.value,
                            client: realName, 
                            displayClient: displayClient, 
                            tech: parseDisplayValue(f['技师&护士']) || '待定', 
                            depts: deptArr,
                            service: serviceArr,
                            startTime: (f['预约时间'] || '').substring(0, 5),
                            endTime: (f['结束时间'] || '').substring(0, 5),
                            duration: f['时长'] ||  0,
                            remark: f['备注'] || '',
                            isCanceling: false
                        };
                    });
                    if (authUser.role === '美容师') {
                        processedData = processedData.filter(item => item.depts && item.depts.includes('生活美容'));
                        currentTab.value = '生活美容'; 
                    }
                    rawData.value = processedData;
                    const onDutyRecords = extractWpsData(onDutyJson);
                    const uniqueNames = new Set(); 
                    onDutyRecords.forEach(item => {
                        const f = item.fields || {};
                        const name = f['姓名'];
                        if (name && name !== '无指定' && name !== '生美' && name !== '医美') {
                            uniqueNames.add(name);
                        }
                    });
                    restingList.value = Array.from(uniqueNames);
                } catch (error) {
                    console.error('API Error:', error);
                } finally {
                    loading.value = false;
                }
            };

            const filteredSchedule = computed(() => {
                if (rawData.value.length === 0) return [];
                return rawData.value.filter(item => {
                    if (currentTab.value === '全部') return true;
                    // 确保 depts 是数组且不为空
                    if (!item.depts || !Array.isArray(item.depts) || item.depts.length === 0) {
                        return false;
                    }
                    // 检查部门数组中是否包含当前选择的标签（去除空格后比较）
                    const normalizedTab = String(currentTab.value).trim();
                    return item.depts.some(dept => {
                        const normalizedDept = String(dept).trim();
                        return normalizedDept === normalizedTab;
                    });
                }).sort((a, b) => a.startTime.localeCompare(b.startTime));
            });
            
            const getTagClass = (name) => {
                const knownTags = ['水光', '光子', '清洁', '测试项目']; 
                if (knownTags.includes(name)) return 'tag-' + name;
                return 'tag-default'; 
            };
            
            // 辅助函数：判断是否包含某部门，用于显示圆点颜色
            const hasDept = (item, deptName) => {
                return item.depts && item.depts.includes(deptName);
            };

            onMounted(async () => {
                await fetchUser();
                loadScheduleData();
            });

            return {
                searchDate,
                currentTab,
                authUser,
                filteredSchedule,
                restingList,
                loading,
                loadScheduleData,
                handleRefresh,
                getTagClass,
                canCancel,
                handleCancel,
                hasDept // 导出新加的辅助函数
            }
        }
    }).mount('#app');
</script>

</body>
</html>